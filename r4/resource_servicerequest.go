// Code generated by gofhir. DO NOT EDIT.
// Source: FHIR StructureDefinitions (consolidated resource)
// Package: r4

package r4

import (
	"bytes"
	"encoding/json"
	"encoding/xml"
	"fmt"
)

// =============================================================================
// ServiceRequest Resource
// =============================================================================

// ServiceRequest represents FHIR ServiceRequest.
type ServiceRequest struct {
	// FHIR resource type
	ResourceType string `json:"resourceType"`
	// Logical id of this artifact
	Id *string `json:"id,omitempty"`
	// Metadata about the resource
	Meta *Meta `json:"meta,omitempty"`
	// A set of rules under which this content was created
	ImplicitRules *string `json:"implicitRules,omitempty"`
	// Extension for ImplicitRules
	ImplicitRulesExt *Element `json:"_implicitRules,omitempty"`
	// Language of the resource content
	Language *string `json:"language,omitempty"`
	// Extension for Language
	LanguageExt *Element `json:"_language,omitempty"`
	// Text summary of the resource, for human interpretation
	Text *Narrative `json:"text,omitempty"`
	// Contained, inline Resources
	Contained []Resource `json:"contained,omitempty"`
	// Additional content defined by implementations
	Extension []Extension `json:"extension,omitempty"`
	// Extensions that cannot be ignored
	ModifierExtension []Extension `json:"modifierExtension,omitempty"`
	// Identifiers assigned to this order
	Identifier []Identifier `json:"identifier,omitempty"`
	// Instantiates FHIR protocol or definition
	InstantiatesCanonical []string `json:"instantiatesCanonical,omitempty"`
	// Extension for InstantiatesCanonical
	InstantiatesCanonicalExt []Element `json:"_instantiatesCanonical,omitempty"`
	// Instantiates external protocol or definition
	InstantiatesUri []string `json:"instantiatesUri,omitempty"`
	// Extension for InstantiatesUri
	InstantiatesUriExt []Element `json:"_instantiatesUri,omitempty"`
	// What request fulfills
	BasedOn []Reference `json:"basedOn,omitempty"`
	// What request replaces
	Replaces []Reference `json:"replaces,omitempty"`
	// Composite Request ID
	Requisition *Identifier `json:"requisition,omitempty"`
	// draft | active | on-hold | revoked | completed | entered-in-error | unknown
	Status *RequestStatus `json:"status,omitempty"`
	// Extension for Status
	StatusExt *Element `json:"_status,omitempty"`
	// proposal | plan | directive | order | original-order | reflex-order | filler-order | instance-order | option
	Intent *RequestIntent `json:"intent,omitempty"`
	// Extension for Intent
	IntentExt *Element `json:"_intent,omitempty"`
	// Classification of service
	Category []CodeableConcept `json:"category,omitempty"`
	// routine | urgent | asap | stat
	Priority *RequestPriority `json:"priority,omitempty"`
	// Extension for Priority
	PriorityExt *Element `json:"_priority,omitempty"`
	// True if service/procedure should not be performed
	DoNotPerform *bool `json:"doNotPerform,omitempty"`
	// Extension for DoNotPerform
	DoNotPerformExt *Element `json:"_doNotPerform,omitempty"`
	// What is being requested/ordered
	Code *CodeableConcept `json:"code,omitempty"`
	// Additional order information
	OrderDetail []CodeableConcept `json:"orderDetail,omitempty"`
	// Service amount
	QuantityQuantity *Quantity `json:"quantityQuantity,omitempty"`
	// Service amount
	QuantityRatio *Ratio `json:"quantityRatio,omitempty"`
	// Service amount
	QuantityRange *Range `json:"quantityRange,omitempty"`
	// Individual or Entity the service is ordered for
	Subject Reference `json:"subject"`
	// Encounter in which the request was created
	Encounter *Reference `json:"encounter,omitempty"`
	// When service should occur
	OccurrenceDateTime *string `json:"occurrenceDateTime,omitempty"`
	// Extension for OccurrenceDateTime
	OccurrenceDateTimeExt *Element `json:"_occurrenceDateTime,omitempty"`
	// When service should occur
	OccurrencePeriod *Period `json:"occurrencePeriod,omitempty"`
	// When service should occur
	OccurrenceTiming *Timing `json:"occurrenceTiming,omitempty"`
	// Preconditions for service
	AsNeededBoolean *bool `json:"asNeededBoolean,omitempty"`
	// Extension for AsNeededBoolean
	AsNeededBooleanExt *Element `json:"_asNeededBoolean,omitempty"`
	// Preconditions for service
	AsNeededCodeableConcept *CodeableConcept `json:"asNeededCodeableConcept,omitempty"`
	// Date request signed
	AuthoredOn *string `json:"authoredOn,omitempty"`
	// Extension for AuthoredOn
	AuthoredOnExt *Element `json:"_authoredOn,omitempty"`
	// Who/what is requesting service
	Requester *Reference `json:"requester,omitempty"`
	// Performer role
	PerformerType *CodeableConcept `json:"performerType,omitempty"`
	// Requested performer
	Performer []Reference `json:"performer,omitempty"`
	// Requested location
	LocationCode []CodeableConcept `json:"locationCode,omitempty"`
	// Requested location
	LocationReference []Reference `json:"locationReference,omitempty"`
	// Explanation/Justification for procedure or service
	ReasonCode []CodeableConcept `json:"reasonCode,omitempty"`
	// Explanation/Justification for service or service
	ReasonReference []Reference `json:"reasonReference,omitempty"`
	// Associated insurance coverage
	Insurance []Reference `json:"insurance,omitempty"`
	// Additional clinical information
	SupportingInfo []Reference `json:"supportingInfo,omitempty"`
	// Procedure Samples
	Specimen []Reference `json:"specimen,omitempty"`
	// Location on Body
	BodySite []CodeableConcept `json:"bodySite,omitempty"`
	// Comments
	Note []Annotation `json:"note,omitempty"`
	// Patient or consumer-oriented instructions
	PatientInstruction *string `json:"patientInstruction,omitempty"`
	// Extension for PatientInstruction
	PatientInstructionExt *Element `json:"_patientInstruction,omitempty"`
	// Request provenance
	RelevantHistory []Reference `json:"relevantHistory,omitempty"`
}

// GetResourceType returns the FHIR resource type.
func (r *ServiceRequest) GetResourceType() string {
	return "ServiceRequest"
}

// GetId returns the resource's logical ID.
func (r *ServiceRequest) GetId() *string {
	return r.Id
}

// SetId sets the resource's logical ID.
func (r *ServiceRequest) SetId(id string) {
	r.Id = &id
}

// GetMeta returns the resource's Meta element.
func (r *ServiceRequest) GetMeta() *Meta {
	return r.Meta
}

// SetMeta sets the resource's Meta element.
func (r *ServiceRequest) SetMeta(m *Meta) {
	r.Meta = m
}

// GetText returns the resource's narrative text.
func (r *ServiceRequest) GetText() *Narrative {
	return r.Text
}

// SetText sets the resource's narrative text.
func (r *ServiceRequest) SetText(t *Narrative) {
	r.Text = t
}

// GetContained returns the resource's contained resources.
func (r *ServiceRequest) GetContained() []Resource {
	return r.Contained
}

// GetExtension returns the resource's extensions.
func (r *ServiceRequest) GetExtension() []Extension {
	return r.Extension
}

// GetModifierExtension returns the resource's modifier extensions.
func (r *ServiceRequest) GetModifierExtension() []Extension {
	return r.ModifierExtension
}

// MarshalJSON ensures resourceType is always included in JSON output.
// HTML escaping is disabled to preserve FHIR narrative XHTML content.
//
// Note: Use the package-level Marshal function instead of json.Marshal
// to ensure HTML in narrative text.div fields is not escaped.
func (r ServiceRequest) MarshalJSON() ([]byte, error) {
	r.ResourceType = "ServiceRequest"
	type Alias ServiceRequest
	var buf bytes.Buffer
	enc := json.NewEncoder(&buf)
	enc.SetEscapeHTML(false)
	if err := enc.Encode((Alias)(r)); err != nil {
		return nil, err
	}
	b := buf.Bytes()
	if len(b) > 0 && b[len(b)-1] == '\n' {
		b = b[:len(b)-1]
	}
	return b, nil
}

// UnmarshalJSON handles deserialization of polymorphic contained resources.
func (r *ServiceRequest) UnmarshalJSON(data []byte) error {
	// Use an alias to avoid infinite recursion
	type Alias ServiceRequest
	aux := &struct {
		Contained []json.RawMessage `json:"contained,omitempty"`
		*Alias
	}{
		Alias: (*Alias)(r),
	}

	if err := json.Unmarshal(data, aux); err != nil {
		return err
	}

	// Unmarshal each contained resource using the dispatcher
	if len(aux.Contained) > 0 {
		r.Contained = make([]Resource, len(aux.Contained))
		for i, raw := range aux.Contained {
			resource, err := UnmarshalResource(raw)
			if err != nil {
				return fmt.Errorf("failed to unmarshal contained[%d]: %w", i, err)
			}
			r.Contained[i] = resource
		}
	}

	return nil
}

// MarshalXML serializes ServiceRequest to FHIR-conformant XML.
func (r ServiceRequest) MarshalXML(e *xml.Encoder, start xml.StartElement) error {
	if start.Name.Local == "" {
		start.Name.Local = "ServiceRequest"
		start.Name.Space = fhirNamespace
	}
	if err := e.EncodeToken(start); err != nil {
		return err
	}

	if err := xmlEncodePrimitiveString(e, "id", r.Id, nil); err != nil {
		return err
	}
	if r.Meta != nil {
		if err := r.Meta.MarshalXML(e, xml.StartElement{Name: xml.Name{Local: "meta"}}); err != nil {
			return err
		}
	}
	if err := xmlEncodePrimitiveString(e, "implicitRules", r.ImplicitRules, r.ImplicitRulesExt); err != nil {
		return err
	}
	if err := xmlEncodePrimitiveString(e, "language", r.Language, r.LanguageExt); err != nil {
		return err
	}
	if r.Text != nil {
		if err := r.Text.MarshalXML(e, xml.StartElement{Name: xml.Name{Local: "text"}}); err != nil {
			return err
		}
	}
	for _, c := range r.Contained {
		if c != nil {
			if err := xmlEncodeContainedResource(e, c); err != nil {
				return err
			}
		}
	}
	for _, item := range r.Extension {
		if err := item.MarshalXML(e, xml.StartElement{Name: xml.Name{Local: "extension"}}); err != nil {
			return err
		}
	}
	for _, item := range r.ModifierExtension {
		if err := item.MarshalXML(e, xml.StartElement{Name: xml.Name{Local: "modifierExtension"}}); err != nil {
			return err
		}
	}
	for _, item := range r.Identifier {
		if err := item.MarshalXML(e, xml.StartElement{Name: xml.Name{Local: "identifier"}}); err != nil {
			return err
		}
	}
	if err := xmlEncodePrimitiveStringArray(e, "instantiatesCanonical", r.InstantiatesCanonical, r.InstantiatesCanonicalExt); err != nil {
		return err
	}
	if err := xmlEncodePrimitiveStringArray(e, "instantiatesUri", r.InstantiatesUri, r.InstantiatesUriExt); err != nil {
		return err
	}
	for _, item := range r.BasedOn {
		if err := item.MarshalXML(e, xml.StartElement{Name: xml.Name{Local: "basedOn"}}); err != nil {
			return err
		}
	}
	for _, item := range r.Replaces {
		if err := item.MarshalXML(e, xml.StartElement{Name: xml.Name{Local: "replaces"}}); err != nil {
			return err
		}
	}
	if r.Requisition != nil {
		if err := r.Requisition.MarshalXML(e, xml.StartElement{Name: xml.Name{Local: "requisition"}}); err != nil {
			return err
		}
	}
	if err := xmlEncodePrimitiveCode(e, "status", r.Status, r.StatusExt); err != nil {
		return err
	}
	if err := xmlEncodePrimitiveCode(e, "intent", r.Intent, r.IntentExt); err != nil {
		return err
	}
	for _, item := range r.Category {
		if err := item.MarshalXML(e, xml.StartElement{Name: xml.Name{Local: "category"}}); err != nil {
			return err
		}
	}
	if err := xmlEncodePrimitiveCode(e, "priority", r.Priority, r.PriorityExt); err != nil {
		return err
	}
	if err := xmlEncodePrimitiveBool(e, "doNotPerform", r.DoNotPerform, r.DoNotPerformExt); err != nil {
		return err
	}
	if r.Code != nil {
		if err := r.Code.MarshalXML(e, xml.StartElement{Name: xml.Name{Local: "code"}}); err != nil {
			return err
		}
	}
	for _, item := range r.OrderDetail {
		if err := item.MarshalXML(e, xml.StartElement{Name: xml.Name{Local: "orderDetail"}}); err != nil {
			return err
		}
	}
	if r.QuantityQuantity != nil {
		if err := r.QuantityQuantity.MarshalXML(e, xml.StartElement{Name: xml.Name{Local: "quantityQuantity"}}); err != nil {
			return err
		}
	}
	if r.QuantityRatio != nil {
		if err := r.QuantityRatio.MarshalXML(e, xml.StartElement{Name: xml.Name{Local: "quantityRatio"}}); err != nil {
			return err
		}
	}
	if r.QuantityRange != nil {
		if err := r.QuantityRange.MarshalXML(e, xml.StartElement{Name: xml.Name{Local: "quantityRange"}}); err != nil {
			return err
		}
	}
	if err := r.Subject.MarshalXML(e, xml.StartElement{Name: xml.Name{Local: "subject"}}); err != nil {
		return err
	}
	if r.Encounter != nil {
		if err := r.Encounter.MarshalXML(e, xml.StartElement{Name: xml.Name{Local: "encounter"}}); err != nil {
			return err
		}
	}
	if err := xmlEncodePrimitiveString(e, "occurrenceDateTime", r.OccurrenceDateTime, nil); err != nil {
		return err
	}
	if r.OccurrencePeriod != nil {
		if err := r.OccurrencePeriod.MarshalXML(e, xml.StartElement{Name: xml.Name{Local: "occurrencePeriod"}}); err != nil {
			return err
		}
	}
	if r.OccurrenceTiming != nil {
		if err := r.OccurrenceTiming.MarshalXML(e, xml.StartElement{Name: xml.Name{Local: "occurrenceTiming"}}); err != nil {
			return err
		}
	}
	if err := xmlEncodePrimitiveBool(e, "asNeededBoolean", r.AsNeededBoolean, nil); err != nil {
		return err
	}
	if r.AsNeededCodeableConcept != nil {
		if err := r.AsNeededCodeableConcept.MarshalXML(e, xml.StartElement{Name: xml.Name{Local: "asNeededCodeableConcept"}}); err != nil {
			return err
		}
	}
	if err := xmlEncodePrimitiveString(e, "authoredOn", r.AuthoredOn, r.AuthoredOnExt); err != nil {
		return err
	}
	if r.Requester != nil {
		if err := r.Requester.MarshalXML(e, xml.StartElement{Name: xml.Name{Local: "requester"}}); err != nil {
			return err
		}
	}
	if r.PerformerType != nil {
		if err := r.PerformerType.MarshalXML(e, xml.StartElement{Name: xml.Name{Local: "performerType"}}); err != nil {
			return err
		}
	}
	for _, item := range r.Performer {
		if err := item.MarshalXML(e, xml.StartElement{Name: xml.Name{Local: "performer"}}); err != nil {
			return err
		}
	}
	for _, item := range r.LocationCode {
		if err := item.MarshalXML(e, xml.StartElement{Name: xml.Name{Local: "locationCode"}}); err != nil {
			return err
		}
	}
	for _, item := range r.LocationReference {
		if err := item.MarshalXML(e, xml.StartElement{Name: xml.Name{Local: "locationReference"}}); err != nil {
			return err
		}
	}
	for _, item := range r.ReasonCode {
		if err := item.MarshalXML(e, xml.StartElement{Name: xml.Name{Local: "reasonCode"}}); err != nil {
			return err
		}
	}
	for _, item := range r.ReasonReference {
		if err := item.MarshalXML(e, xml.StartElement{Name: xml.Name{Local: "reasonReference"}}); err != nil {
			return err
		}
	}
	for _, item := range r.Insurance {
		if err := item.MarshalXML(e, xml.StartElement{Name: xml.Name{Local: "insurance"}}); err != nil {
			return err
		}
	}
	for _, item := range r.SupportingInfo {
		if err := item.MarshalXML(e, xml.StartElement{Name: xml.Name{Local: "supportingInfo"}}); err != nil {
			return err
		}
	}
	for _, item := range r.Specimen {
		if err := item.MarshalXML(e, xml.StartElement{Name: xml.Name{Local: "specimen"}}); err != nil {
			return err
		}
	}
	for _, item := range r.BodySite {
		if err := item.MarshalXML(e, xml.StartElement{Name: xml.Name{Local: "bodySite"}}); err != nil {
			return err
		}
	}
	for _, item := range r.Note {
		if err := item.MarshalXML(e, xml.StartElement{Name: xml.Name{Local: "note"}}); err != nil {
			return err
		}
	}
	if err := xmlEncodePrimitiveString(e, "patientInstruction", r.PatientInstruction, r.PatientInstructionExt); err != nil {
		return err
	}
	for _, item := range r.RelevantHistory {
		if err := item.MarshalXML(e, xml.StartElement{Name: xml.Name{Local: "relevantHistory"}}); err != nil {
			return err
		}
	}

	return e.EncodeToken(start.End())
}

// UnmarshalXML deserializes ServiceRequest from FHIR-conformant XML.
func (r *ServiceRequest) UnmarshalXML(d *xml.Decoder, start xml.StartElement) error {
	for {
		tok, err := d.Token()
		if err != nil {
			return err
		}
		switch t := tok.(type) {
		case xml.StartElement:
			switch t.Name.Local {
			case "id":
				v, _, err := xmlDecodePrimitiveString(d, t)
				if err != nil {
					return err
				}
				r.Id = v
			case "meta":
				var v Meta
				if err := v.UnmarshalXML(d, t); err != nil {
					return err
				}
				r.Meta = &v
			case "implicitRules":
				v, ext, err := xmlDecodePrimitiveString(d, t)
				if err != nil {
					return err
				}
				r.ImplicitRules = v
				r.ImplicitRulesExt = ext
			case "language":
				v, ext, err := xmlDecodePrimitiveString(d, t)
				if err != nil {
					return err
				}
				r.Language = v
				r.LanguageExt = ext
			case "text":
				var v Narrative
				if err := v.UnmarshalXML(d, t); err != nil {
					return err
				}
				r.Text = &v
			case "contained":
				res, err := xmlDecodeContainedResource(d, t)
				if err != nil {
					return err
				}
				if res != nil {
					r.Contained = append(r.Contained, res)
				}
			case "extension":
				var v Extension
				if err := v.UnmarshalXML(d, t); err != nil {
					return err
				}
				r.Extension = append(r.Extension, v)
			case "modifierExtension":
				var v Extension
				if err := v.UnmarshalXML(d, t); err != nil {
					return err
				}
				r.ModifierExtension = append(r.ModifierExtension, v)
			case "identifier":
				var v Identifier
				if err := v.UnmarshalXML(d, t); err != nil {
					return err
				}
				r.Identifier = append(r.Identifier, v)
			case "instantiatesCanonical":
				v, _, err := xmlDecodePrimitiveString(d, t)
				if err != nil {
					return err
				}
				if v != nil {
					r.InstantiatesCanonical = append(r.InstantiatesCanonical, *v)
				}
			case "instantiatesUri":
				v, _, err := xmlDecodePrimitiveString(d, t)
				if err != nil {
					return err
				}
				if v != nil {
					r.InstantiatesUri = append(r.InstantiatesUri, *v)
				}
			case "basedOn":
				var v Reference
				if err := v.UnmarshalXML(d, t); err != nil {
					return err
				}
				r.BasedOn = append(r.BasedOn, v)
			case "replaces":
				var v Reference
				if err := v.UnmarshalXML(d, t); err != nil {
					return err
				}
				r.Replaces = append(r.Replaces, v)
			case "requisition":
				var v Identifier
				if err := v.UnmarshalXML(d, t); err != nil {
					return err
				}
				r.Requisition = &v
			case "status":
				v, ext, err := xmlDecodePrimitiveCode[RequestStatus](d, t)
				if err != nil {
					return err
				}
				r.Status = v
				r.StatusExt = ext
			case "intent":
				v, ext, err := xmlDecodePrimitiveCode[RequestIntent](d, t)
				if err != nil {
					return err
				}
				r.Intent = v
				r.IntentExt = ext
			case "category":
				var v CodeableConcept
				if err := v.UnmarshalXML(d, t); err != nil {
					return err
				}
				r.Category = append(r.Category, v)
			case "priority":
				v, ext, err := xmlDecodePrimitiveCode[RequestPriority](d, t)
				if err != nil {
					return err
				}
				r.Priority = v
				r.PriorityExt = ext
			case "doNotPerform":
				v, ext, err := xmlDecodePrimitiveBool(d, t)
				if err != nil {
					return err
				}
				r.DoNotPerform = v
				r.DoNotPerformExt = ext
			case "code":
				var v CodeableConcept
				if err := v.UnmarshalXML(d, t); err != nil {
					return err
				}
				r.Code = &v
			case "orderDetail":
				var v CodeableConcept
				if err := v.UnmarshalXML(d, t); err != nil {
					return err
				}
				r.OrderDetail = append(r.OrderDetail, v)
			case "quantityQuantity":
				var v Quantity
				if err := v.UnmarshalXML(d, t); err != nil {
					return err
				}
				r.QuantityQuantity = &v
			case "quantityRatio":
				var v Ratio
				if err := v.UnmarshalXML(d, t); err != nil {
					return err
				}
				r.QuantityRatio = &v
			case "quantityRange":
				var v Range
				if err := v.UnmarshalXML(d, t); err != nil {
					return err
				}
				r.QuantityRange = &v
			case "subject":
				if err := r.Subject.UnmarshalXML(d, t); err != nil {
					return err
				}
			case "encounter":
				var v Reference
				if err := v.UnmarshalXML(d, t); err != nil {
					return err
				}
				r.Encounter = &v
			case "occurrenceDateTime":
				v, ext, err := xmlDecodePrimitiveString(d, t)
				if err != nil {
					return err
				}
				r.OccurrenceDateTime = v
				_ = ext
			case "occurrencePeriod":
				var v Period
				if err := v.UnmarshalXML(d, t); err != nil {
					return err
				}
				r.OccurrencePeriod = &v
			case "occurrenceTiming":
				var v Timing
				if err := v.UnmarshalXML(d, t); err != nil {
					return err
				}
				r.OccurrenceTiming = &v
			case "asNeededBoolean":
				v, ext, err := xmlDecodePrimitiveBool(d, t)
				if err != nil {
					return err
				}
				r.AsNeededBoolean = v
				_ = ext
			case "asNeededCodeableConcept":
				var v CodeableConcept
				if err := v.UnmarshalXML(d, t); err != nil {
					return err
				}
				r.AsNeededCodeableConcept = &v
			case "authoredOn":
				v, ext, err := xmlDecodePrimitiveString(d, t)
				if err != nil {
					return err
				}
				r.AuthoredOn = v
				r.AuthoredOnExt = ext
			case "requester":
				var v Reference
				if err := v.UnmarshalXML(d, t); err != nil {
					return err
				}
				r.Requester = &v
			case "performerType":
				var v CodeableConcept
				if err := v.UnmarshalXML(d, t); err != nil {
					return err
				}
				r.PerformerType = &v
			case "performer":
				var v Reference
				if err := v.UnmarshalXML(d, t); err != nil {
					return err
				}
				r.Performer = append(r.Performer, v)
			case "locationCode":
				var v CodeableConcept
				if err := v.UnmarshalXML(d, t); err != nil {
					return err
				}
				r.LocationCode = append(r.LocationCode, v)
			case "locationReference":
				var v Reference
				if err := v.UnmarshalXML(d, t); err != nil {
					return err
				}
				r.LocationReference = append(r.LocationReference, v)
			case "reasonCode":
				var v CodeableConcept
				if err := v.UnmarshalXML(d, t); err != nil {
					return err
				}
				r.ReasonCode = append(r.ReasonCode, v)
			case "reasonReference":
				var v Reference
				if err := v.UnmarshalXML(d, t); err != nil {
					return err
				}
				r.ReasonReference = append(r.ReasonReference, v)
			case "insurance":
				var v Reference
				if err := v.UnmarshalXML(d, t); err != nil {
					return err
				}
				r.Insurance = append(r.Insurance, v)
			case "supportingInfo":
				var v Reference
				if err := v.UnmarshalXML(d, t); err != nil {
					return err
				}
				r.SupportingInfo = append(r.SupportingInfo, v)
			case "specimen":
				var v Reference
				if err := v.UnmarshalXML(d, t); err != nil {
					return err
				}
				r.Specimen = append(r.Specimen, v)
			case "bodySite":
				var v CodeableConcept
				if err := v.UnmarshalXML(d, t); err != nil {
					return err
				}
				r.BodySite = append(r.BodySite, v)
			case "note":
				var v Annotation
				if err := v.UnmarshalXML(d, t); err != nil {
					return err
				}
				r.Note = append(r.Note, v)
			case "patientInstruction":
				v, ext, err := xmlDecodePrimitiveString(d, t)
				if err != nil {
					return err
				}
				r.PatientInstruction = v
				r.PatientInstructionExt = ext
			case "relevantHistory":
				var v Reference
				if err := v.UnmarshalXML(d, t); err != nil {
					return err
				}
				r.RelevantHistory = append(r.RelevantHistory, v)
			default:
				if err := d.Skip(); err != nil {
					return err
				}
			}
		case xml.EndElement:
			return nil
		}
	}
}

// =============================================================================
// ServiceRequest - Fluent Builder
// =============================================================================

// ServiceRequestBuilder provides a fluent API for constructing ServiceRequest resources.
type ServiceRequestBuilder struct {
	serviceRequest *ServiceRequest
}

// NewServiceRequestBuilder creates a new ServiceRequestBuilder.
func NewServiceRequestBuilder() *ServiceRequestBuilder {
	return &ServiceRequestBuilder{
		serviceRequest: &ServiceRequest{},
	}
}

// Build returns the constructed ServiceRequest resource.
func (b *ServiceRequestBuilder) Build() *ServiceRequest {
	return b.serviceRequest
}

// SetId sets the Id field.
func (b *ServiceRequestBuilder) SetId(v string) *ServiceRequestBuilder {
	b.serviceRequest.Id = &v
	return b
}

// SetMeta sets the Meta field.
func (b *ServiceRequestBuilder) SetMeta(v Meta) *ServiceRequestBuilder {
	b.serviceRequest.Meta = &v
	return b
}

// SetImplicitRules sets the ImplicitRules field.
func (b *ServiceRequestBuilder) SetImplicitRules(v string) *ServiceRequestBuilder {
	b.serviceRequest.ImplicitRules = &v
	return b
}

// SetLanguage sets the Language field.
func (b *ServiceRequestBuilder) SetLanguage(v string) *ServiceRequestBuilder {
	b.serviceRequest.Language = &v
	return b
}

// SetText sets the Text field.
func (b *ServiceRequestBuilder) SetText(v Narrative) *ServiceRequestBuilder {
	b.serviceRequest.Text = &v
	return b
}

// AddContained adds a Contained element.
func (b *ServiceRequestBuilder) AddContained(v Resource) *ServiceRequestBuilder {
	b.serviceRequest.Contained = append(b.serviceRequest.Contained, v)
	return b
}

// AddExtension adds a Extension element.
func (b *ServiceRequestBuilder) AddExtension(v Extension) *ServiceRequestBuilder {
	b.serviceRequest.Extension = append(b.serviceRequest.Extension, v)
	return b
}

// AddModifierExtension adds a ModifierExtension element.
func (b *ServiceRequestBuilder) AddModifierExtension(v Extension) *ServiceRequestBuilder {
	b.serviceRequest.ModifierExtension = append(b.serviceRequest.ModifierExtension, v)
	return b
}

// AddIdentifier adds a Identifier element.
func (b *ServiceRequestBuilder) AddIdentifier(v Identifier) *ServiceRequestBuilder {
	b.serviceRequest.Identifier = append(b.serviceRequest.Identifier, v)
	return b
}

// AddInstantiatesCanonical adds a InstantiatesCanonical element.
func (b *ServiceRequestBuilder) AddInstantiatesCanonical(v string) *ServiceRequestBuilder {
	b.serviceRequest.InstantiatesCanonical = append(b.serviceRequest.InstantiatesCanonical, v)
	return b
}

// AddInstantiatesUri adds a InstantiatesUri element.
func (b *ServiceRequestBuilder) AddInstantiatesUri(v string) *ServiceRequestBuilder {
	b.serviceRequest.InstantiatesUri = append(b.serviceRequest.InstantiatesUri, v)
	return b
}

// AddBasedOn adds a BasedOn element.
func (b *ServiceRequestBuilder) AddBasedOn(v Reference) *ServiceRequestBuilder {
	b.serviceRequest.BasedOn = append(b.serviceRequest.BasedOn, v)
	return b
}

// AddReplaces adds a Replaces element.
func (b *ServiceRequestBuilder) AddReplaces(v Reference) *ServiceRequestBuilder {
	b.serviceRequest.Replaces = append(b.serviceRequest.Replaces, v)
	return b
}

// SetRequisition sets the Requisition field.
func (b *ServiceRequestBuilder) SetRequisition(v Identifier) *ServiceRequestBuilder {
	b.serviceRequest.Requisition = &v
	return b
}

// SetStatus sets the Status field.
func (b *ServiceRequestBuilder) SetStatus(v RequestStatus) *ServiceRequestBuilder {
	b.serviceRequest.Status = &v
	return b
}

// SetIntent sets the Intent field.
func (b *ServiceRequestBuilder) SetIntent(v RequestIntent) *ServiceRequestBuilder {
	b.serviceRequest.Intent = &v
	return b
}

// AddCategory adds a Category element.
func (b *ServiceRequestBuilder) AddCategory(v CodeableConcept) *ServiceRequestBuilder {
	b.serviceRequest.Category = append(b.serviceRequest.Category, v)
	return b
}

// SetPriority sets the Priority field.
func (b *ServiceRequestBuilder) SetPriority(v RequestPriority) *ServiceRequestBuilder {
	b.serviceRequest.Priority = &v
	return b
}

// SetDoNotPerform sets the DoNotPerform field.
func (b *ServiceRequestBuilder) SetDoNotPerform(v bool) *ServiceRequestBuilder {
	b.serviceRequest.DoNotPerform = &v
	return b
}

// SetCode sets the Code field.
func (b *ServiceRequestBuilder) SetCode(v CodeableConcept) *ServiceRequestBuilder {
	b.serviceRequest.Code = &v
	return b
}

// AddOrderDetail adds a OrderDetail element.
func (b *ServiceRequestBuilder) AddOrderDetail(v CodeableConcept) *ServiceRequestBuilder {
	b.serviceRequest.OrderDetail = append(b.serviceRequest.OrderDetail, v)
	return b
}

// SetQuantityQuantity sets the QuantityQuantity field.
func (b *ServiceRequestBuilder) SetQuantityQuantity(v Quantity) *ServiceRequestBuilder {
	b.serviceRequest.QuantityQuantity = &v
	return b
}

// SetQuantityRatio sets the QuantityRatio field.
func (b *ServiceRequestBuilder) SetQuantityRatio(v Ratio) *ServiceRequestBuilder {
	b.serviceRequest.QuantityRatio = &v
	return b
}

// SetQuantityRange sets the QuantityRange field.
func (b *ServiceRequestBuilder) SetQuantityRange(v Range) *ServiceRequestBuilder {
	b.serviceRequest.QuantityRange = &v
	return b
}

// SetSubject sets the Subject field.
func (b *ServiceRequestBuilder) SetSubject(v Reference) *ServiceRequestBuilder {
	b.serviceRequest.Subject = v
	return b
}

// SetEncounter sets the Encounter field.
func (b *ServiceRequestBuilder) SetEncounter(v Reference) *ServiceRequestBuilder {
	b.serviceRequest.Encounter = &v
	return b
}

// SetOccurrenceDateTime sets the OccurrenceDateTime field.
func (b *ServiceRequestBuilder) SetOccurrenceDateTime(v string) *ServiceRequestBuilder {
	b.serviceRequest.OccurrenceDateTime = &v
	return b
}

// SetOccurrenceDateTimeExt sets the OccurrenceDateTimeExt field.
func (b *ServiceRequestBuilder) SetOccurrenceDateTimeExt(v Element) *ServiceRequestBuilder {
	b.serviceRequest.OccurrenceDateTimeExt = &v
	return b
}

// SetOccurrencePeriod sets the OccurrencePeriod field.
func (b *ServiceRequestBuilder) SetOccurrencePeriod(v Period) *ServiceRequestBuilder {
	b.serviceRequest.OccurrencePeriod = &v
	return b
}

// SetOccurrenceTiming sets the OccurrenceTiming field.
func (b *ServiceRequestBuilder) SetOccurrenceTiming(v Timing) *ServiceRequestBuilder {
	b.serviceRequest.OccurrenceTiming = &v
	return b
}

// SetAsNeededBoolean sets the AsNeededBoolean field.
func (b *ServiceRequestBuilder) SetAsNeededBoolean(v bool) *ServiceRequestBuilder {
	b.serviceRequest.AsNeededBoolean = &v
	return b
}

// SetAsNeededBooleanExt sets the AsNeededBooleanExt field.
func (b *ServiceRequestBuilder) SetAsNeededBooleanExt(v Element) *ServiceRequestBuilder {
	b.serviceRequest.AsNeededBooleanExt = &v
	return b
}

// SetAsNeededCodeableConcept sets the AsNeededCodeableConcept field.
func (b *ServiceRequestBuilder) SetAsNeededCodeableConcept(v CodeableConcept) *ServiceRequestBuilder {
	b.serviceRequest.AsNeededCodeableConcept = &v
	return b
}

// SetAuthoredOn sets the AuthoredOn field.
func (b *ServiceRequestBuilder) SetAuthoredOn(v string) *ServiceRequestBuilder {
	b.serviceRequest.AuthoredOn = &v
	return b
}

// SetRequester sets the Requester field.
func (b *ServiceRequestBuilder) SetRequester(v Reference) *ServiceRequestBuilder {
	b.serviceRequest.Requester = &v
	return b
}

// SetPerformerType sets the PerformerType field.
func (b *ServiceRequestBuilder) SetPerformerType(v CodeableConcept) *ServiceRequestBuilder {
	b.serviceRequest.PerformerType = &v
	return b
}

// AddPerformer adds a Performer element.
func (b *ServiceRequestBuilder) AddPerformer(v Reference) *ServiceRequestBuilder {
	b.serviceRequest.Performer = append(b.serviceRequest.Performer, v)
	return b
}

// AddLocationCode adds a LocationCode element.
func (b *ServiceRequestBuilder) AddLocationCode(v CodeableConcept) *ServiceRequestBuilder {
	b.serviceRequest.LocationCode = append(b.serviceRequest.LocationCode, v)
	return b
}

// AddLocationReference adds a LocationReference element.
func (b *ServiceRequestBuilder) AddLocationReference(v Reference) *ServiceRequestBuilder {
	b.serviceRequest.LocationReference = append(b.serviceRequest.LocationReference, v)
	return b
}

// AddReasonCode adds a ReasonCode element.
func (b *ServiceRequestBuilder) AddReasonCode(v CodeableConcept) *ServiceRequestBuilder {
	b.serviceRequest.ReasonCode = append(b.serviceRequest.ReasonCode, v)
	return b
}

// AddReasonReference adds a ReasonReference element.
func (b *ServiceRequestBuilder) AddReasonReference(v Reference) *ServiceRequestBuilder {
	b.serviceRequest.ReasonReference = append(b.serviceRequest.ReasonReference, v)
	return b
}

// AddInsurance adds a Insurance element.
func (b *ServiceRequestBuilder) AddInsurance(v Reference) *ServiceRequestBuilder {
	b.serviceRequest.Insurance = append(b.serviceRequest.Insurance, v)
	return b
}

// AddSupportingInfo adds a SupportingInfo element.
func (b *ServiceRequestBuilder) AddSupportingInfo(v Reference) *ServiceRequestBuilder {
	b.serviceRequest.SupportingInfo = append(b.serviceRequest.SupportingInfo, v)
	return b
}

// AddSpecimen adds a Specimen element.
func (b *ServiceRequestBuilder) AddSpecimen(v Reference) *ServiceRequestBuilder {
	b.serviceRequest.Specimen = append(b.serviceRequest.Specimen, v)
	return b
}

// AddBodySite adds a BodySite element.
func (b *ServiceRequestBuilder) AddBodySite(v CodeableConcept) *ServiceRequestBuilder {
	b.serviceRequest.BodySite = append(b.serviceRequest.BodySite, v)
	return b
}

// AddNote adds a Note element.
func (b *ServiceRequestBuilder) AddNote(v Annotation) *ServiceRequestBuilder {
	b.serviceRequest.Note = append(b.serviceRequest.Note, v)
	return b
}

// SetPatientInstruction sets the PatientInstruction field.
func (b *ServiceRequestBuilder) SetPatientInstruction(v string) *ServiceRequestBuilder {
	b.serviceRequest.PatientInstruction = &v
	return b
}

// AddRelevantHistory adds a RelevantHistory element.
func (b *ServiceRequestBuilder) AddRelevantHistory(v Reference) *ServiceRequestBuilder {
	b.serviceRequest.RelevantHistory = append(b.serviceRequest.RelevantHistory, v)
	return b
}

// =============================================================================
// ServiceRequest - Functional Options
// =============================================================================

// ServiceRequestOption is a functional option for configuring a ServiceRequest.
type ServiceRequestOption func(*ServiceRequest)

// NewServiceRequest creates a new ServiceRequest with the given options.
func NewServiceRequest(opts ...ServiceRequestOption) *ServiceRequest {
	r := &ServiceRequest{}
	for _, opt := range opts {
		opt(r)
	}
	return r
}

// WithServiceRequestId sets the Id field.
func WithServiceRequestId(v string) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.Id = &v
	}
}

// WithServiceRequestMeta sets the Meta field.
func WithServiceRequestMeta(v Meta) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.Meta = &v
	}
}

// WithServiceRequestImplicitRules sets the ImplicitRules field.
func WithServiceRequestImplicitRules(v string) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.ImplicitRules = &v
	}
}

// WithServiceRequestLanguage sets the Language field.
func WithServiceRequestLanguage(v string) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.Language = &v
	}
}

// WithServiceRequestText sets the Text field.
func WithServiceRequestText(v Narrative) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.Text = &v
	}
}

// WithServiceRequestContained adds a Contained to the ServiceRequest.
func WithServiceRequestContained(v Resource) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.Contained = append(r.Contained, v)
	}
}

// WithServiceRequestExtension adds a Extension to the ServiceRequest.
func WithServiceRequestExtension(v Extension) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.Extension = append(r.Extension, v)
	}
}

// WithServiceRequestModifierExtension adds a ModifierExtension to the ServiceRequest.
func WithServiceRequestModifierExtension(v Extension) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.ModifierExtension = append(r.ModifierExtension, v)
	}
}

// WithServiceRequestIdentifier adds a Identifier to the ServiceRequest.
func WithServiceRequestIdentifier(v Identifier) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.Identifier = append(r.Identifier, v)
	}
}

// WithServiceRequestInstantiatesCanonical adds a InstantiatesCanonical to the ServiceRequest.
func WithServiceRequestInstantiatesCanonical(v string) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.InstantiatesCanonical = append(r.InstantiatesCanonical, v)
	}
}

// WithServiceRequestInstantiatesUri adds a InstantiatesUri to the ServiceRequest.
func WithServiceRequestInstantiatesUri(v string) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.InstantiatesUri = append(r.InstantiatesUri, v)
	}
}

// WithServiceRequestBasedOn adds a BasedOn to the ServiceRequest.
func WithServiceRequestBasedOn(v Reference) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.BasedOn = append(r.BasedOn, v)
	}
}

// WithServiceRequestReplaces adds a Replaces to the ServiceRequest.
func WithServiceRequestReplaces(v Reference) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.Replaces = append(r.Replaces, v)
	}
}

// WithServiceRequestRequisition sets the Requisition field.
func WithServiceRequestRequisition(v Identifier) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.Requisition = &v
	}
}

// WithServiceRequestStatus sets the Status field.
func WithServiceRequestStatus(v RequestStatus) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.Status = &v
	}
}

// WithServiceRequestIntent sets the Intent field.
func WithServiceRequestIntent(v RequestIntent) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.Intent = &v
	}
}

// WithServiceRequestCategory adds a Category to the ServiceRequest.
func WithServiceRequestCategory(v CodeableConcept) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.Category = append(r.Category, v)
	}
}

// WithServiceRequestPriority sets the Priority field.
func WithServiceRequestPriority(v RequestPriority) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.Priority = &v
	}
}

// WithServiceRequestDoNotPerform sets the DoNotPerform field.
func WithServiceRequestDoNotPerform(v bool) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.DoNotPerform = &v
	}
}

// WithServiceRequestCode sets the Code field.
func WithServiceRequestCode(v CodeableConcept) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.Code = &v
	}
}

// WithServiceRequestOrderDetail adds a OrderDetail to the ServiceRequest.
func WithServiceRequestOrderDetail(v CodeableConcept) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.OrderDetail = append(r.OrderDetail, v)
	}
}

// WithServiceRequestQuantityQuantity sets the QuantityQuantity field.
func WithServiceRequestQuantityQuantity(v Quantity) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.QuantityQuantity = &v
	}
}

// WithServiceRequestQuantityRatio sets the QuantityRatio field.
func WithServiceRequestQuantityRatio(v Ratio) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.QuantityRatio = &v
	}
}

// WithServiceRequestQuantityRange sets the QuantityRange field.
func WithServiceRequestQuantityRange(v Range) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.QuantityRange = &v
	}
}

// WithServiceRequestSubject sets the Subject field.
func WithServiceRequestSubject(v Reference) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.Subject = v
	}
}

// WithServiceRequestEncounter sets the Encounter field.
func WithServiceRequestEncounter(v Reference) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.Encounter = &v
	}
}

// WithServiceRequestOccurrenceDateTime sets the OccurrenceDateTime field.
func WithServiceRequestOccurrenceDateTime(v string) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.OccurrenceDateTime = &v
	}
}

// WithServiceRequestOccurrenceDateTimeExt sets the OccurrenceDateTimeExt field.
func WithServiceRequestOccurrenceDateTimeExt(v Element) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.OccurrenceDateTimeExt = &v
	}
}

// WithServiceRequestOccurrencePeriod sets the OccurrencePeriod field.
func WithServiceRequestOccurrencePeriod(v Period) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.OccurrencePeriod = &v
	}
}

// WithServiceRequestOccurrenceTiming sets the OccurrenceTiming field.
func WithServiceRequestOccurrenceTiming(v Timing) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.OccurrenceTiming = &v
	}
}

// WithServiceRequestAsNeededBoolean sets the AsNeededBoolean field.
func WithServiceRequestAsNeededBoolean(v bool) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.AsNeededBoolean = &v
	}
}

// WithServiceRequestAsNeededBooleanExt sets the AsNeededBooleanExt field.
func WithServiceRequestAsNeededBooleanExt(v Element) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.AsNeededBooleanExt = &v
	}
}

// WithServiceRequestAsNeededCodeableConcept sets the AsNeededCodeableConcept field.
func WithServiceRequestAsNeededCodeableConcept(v CodeableConcept) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.AsNeededCodeableConcept = &v
	}
}

// WithServiceRequestAuthoredOn sets the AuthoredOn field.
func WithServiceRequestAuthoredOn(v string) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.AuthoredOn = &v
	}
}

// WithServiceRequestRequester sets the Requester field.
func WithServiceRequestRequester(v Reference) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.Requester = &v
	}
}

// WithServiceRequestPerformerType sets the PerformerType field.
func WithServiceRequestPerformerType(v CodeableConcept) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.PerformerType = &v
	}
}

// WithServiceRequestPerformer adds a Performer to the ServiceRequest.
func WithServiceRequestPerformer(v Reference) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.Performer = append(r.Performer, v)
	}
}

// WithServiceRequestLocationCode adds a LocationCode to the ServiceRequest.
func WithServiceRequestLocationCode(v CodeableConcept) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.LocationCode = append(r.LocationCode, v)
	}
}

// WithServiceRequestLocationReference adds a LocationReference to the ServiceRequest.
func WithServiceRequestLocationReference(v Reference) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.LocationReference = append(r.LocationReference, v)
	}
}

// WithServiceRequestReasonCode adds a ReasonCode to the ServiceRequest.
func WithServiceRequestReasonCode(v CodeableConcept) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.ReasonCode = append(r.ReasonCode, v)
	}
}

// WithServiceRequestReasonReference adds a ReasonReference to the ServiceRequest.
func WithServiceRequestReasonReference(v Reference) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.ReasonReference = append(r.ReasonReference, v)
	}
}

// WithServiceRequestInsurance adds a Insurance to the ServiceRequest.
func WithServiceRequestInsurance(v Reference) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.Insurance = append(r.Insurance, v)
	}
}

// WithServiceRequestSupportingInfo adds a SupportingInfo to the ServiceRequest.
func WithServiceRequestSupportingInfo(v Reference) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.SupportingInfo = append(r.SupportingInfo, v)
	}
}

// WithServiceRequestSpecimen adds a Specimen to the ServiceRequest.
func WithServiceRequestSpecimen(v Reference) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.Specimen = append(r.Specimen, v)
	}
}

// WithServiceRequestBodySite adds a BodySite to the ServiceRequest.
func WithServiceRequestBodySite(v CodeableConcept) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.BodySite = append(r.BodySite, v)
	}
}

// WithServiceRequestNote adds a Note to the ServiceRequest.
func WithServiceRequestNote(v Annotation) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.Note = append(r.Note, v)
	}
}

// WithServiceRequestPatientInstruction sets the PatientInstruction field.
func WithServiceRequestPatientInstruction(v string) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.PatientInstruction = &v
	}
}

// WithServiceRequestRelevantHistory adds a RelevantHistory to the ServiceRequest.
func WithServiceRequestRelevantHistory(v Reference) ServiceRequestOption {
	return func(r *ServiceRequest) {
		r.RelevantHistory = append(r.RelevantHistory, v)
	}
}
